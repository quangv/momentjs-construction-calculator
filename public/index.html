<!DOCTYPE html>
<html>
  <head>
    <title>Moment.js Construction Calculator</title>
    <style type="text/css">
    .error {
      color: red;
    }
    #result {
      color: green;
      margin: 1em;
    }
    </style>
  </head>
  <body>

    <form>
      <h1>Construction Estimator</h1>
      <div>
        <h2>Project Details</h2>
        <div>
          <label>Project Name: <input type="text" value="Pizza Palace" id="projectName" ></label>
        </div>
        <div>
          <label>Project End Date: <input type="text" id="projectEndDate" placeholder="YYYY-MM-DD" ></label>
          <span id="projectEndDateError" class="error"></span>
        </div>
        <div>
          <label>Estimated Human Hours: <input type="number" value="1000" id="projectTotalHours" ></label>
        </div>
      </div>

      <div>
        <h2>Worker Details</h2>
        <div>
          <label>Work hours per day: <input type="number" value="8" id="hoursPerDay" ></label>
        </div>
        <div>
          <label>How many humans? <input type="number" value="" id="workers" ></label>
        </div>
      </div>

      <div>
        <button type="submit">Calculate</button>
      </div>
    </form>

    <div id="result">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>
    <script>
      function getProjectEndMoment() {
        var projectEndDate = $('#projectEndDate').val();

        // Date parsed with hyphens (ISO-8601 format) is treated as UTC.
        // Convert hyphens to slashes to treat it as local.
        // http://blog.dygraphs.com/2012/03/javascript-and-dates-what-mess.html
        projectEndDate = projectEndDate.replace(/-/g,'/');

        return moment(Date.parse(projectEndDate));
      }
      $(document).ready(function(){
        // Default Project-End-Date 1 month from now.
        var defaultEndDate = moment().add(1, 'months').format('YYYY-MM-DD');
        $('#projectEndDate').val(defaultEndDate);

        // Check for invalid project end date.
        $('#projectEndDate').on('input', function(){
          var projectEndDate = $('#projectEndDate').val();  // get the text value.
          projectEndDate = new Date(projectEndDate);  // convert to date object.

          if(!moment(projectEndDate).isValid()) {  // Invalid date.
            $('#projectEndDateError').text("Invalid date");
          } else {  // Valid date.
            $('#projectEndDateError').text("");
          }
        })

        // Convert to ISO 8601 format
        $('#projectEndDate').on('change', function(){
          var $projectEndDate = $(this);
          var originalDate = $projectEndDate.val();

          var mProjectEndDate = getProjectEndMoment();
          var newDate = mProjectEndDate.format("YYYY-MM-DD")

          // Change date to ISO 8601 format and alert the user.
          if(mProjectEndDate.isValid() && newDate !== originalDate) {
            $projectEndDate.val(newDate);

            // Alert user their end date has changed
            $('#projectEndDate').animate({
              fontSize: '1.5em'
            }).animate({
              fontSize: '1em'
            })
          }
        });

        // Handle Form Calculation.
        $('form').on('submit', function(event){
          event.preventDefault();
          var $result = $('#result');

          var workers = $('#workers').val();
          var projectEndDate = $('#projectEndDate').val();

          if(!workers) {
            $result.html('<span class="error">Please add some humans.</span>');

          // Check for valid Project End Date.
          } else if(!moment(Date.parse(projectEndDate)).isValid()) {
            $result.html('<span class="error">Needs a valid Project End Date.</span>');

          // Checks if project end date is after today.
          } else if(getProjectEndMoment().isBefore(Date.now())) {
            $result.html('<span class="error">Project end date needs to be after today.</span>');

          } else {
            var result = {};

            // Grab form values
            var totalHours = $('#projectTotalHours').val();

            var hoursPerDay = $('#hoursPerDay').val();

            // Get Actual End-Date
            var totalHours = workers * hoursPerDay * 5;

            result['Total hours a week'] = totalHours;

            // Display Results
            var resultHtml = "";
            for(var k in result) {
              resultHtml += "<div><b>" + k + ":</b> " + result[k] + "</div>"
            }
            $result.html(resultHtml);
          }
        });
      });
    </script>
  </body>
</html>
